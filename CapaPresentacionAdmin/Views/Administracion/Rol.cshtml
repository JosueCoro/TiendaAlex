@{
    ViewBag.Title = "Rol";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Rol</h2>
<div class="mb-3 mt-4">
    <button class="btn btn-primary" onclick="abrirModal()">Crear Rol</button>
</div>

<table class="table table-bordered table-striped" id="tablaRoles">
    <thead>
        <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal -->
<div class="modal fade" id="FormModal1" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Rol</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="txtid" value="0" />

                <div class="mb-3">
                    <label for="txtNombre" class="form-label">Nombre del Rol</label>
                    <input type="text" class="form-control" id="txtNombre" />
                </div>

                <div class="mb-3">
                    <label for="cdactivo" class="form-label">Estado</label>
                    <select class="form-select" id="cdactivo">
                        <option value="1">Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>

                <div id="mensajeError" class="alert alert-danger d-none" role="alert"></div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" onclick="Guardar()">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        cargarRoles();
    });

    function cargarRoles() {
        fetch('@Url.Action("ListarRoles", "Administracion")')
            .then(res => res.json())
            .then(res => {
                const cuerpo = document.querySelector("#tablaRoles tbody");
                cuerpo.innerHTML = "";

                res.data.forEach(rol => {
                    const fila = document.createElement("tr");

                    fila.innerHTML = `
                        <td>${rol.id_rol}</td>
                        <td>${rol.nombre}</td>
                        <td>${rol.estado ? '<span class="badge bg-success">Activo</span>' : '<span class="badge bg-danger">Inactivo</span>'}</td>
                        <td>
                            <button class="btn btn-warning btn-sm me-2" onclick='abrirModal(${JSON.stringify(rol)})'>Editar</button>
                            <button class="btn btn-danger btn-sm" onclick='inactivarRol(${rol.id_rol})'>Inactivar</button>
                        </td>
                    `;
                    cuerpo.appendChild(fila);
                });
            })
            .catch(err => console.error("Error al cargar roles:", err));
    }

    function abrirModal(rol = null) {
        document.getElementById("txtid").value = rol?.id_rol || 0;
        document.getElementById("txtNombre").value = rol?.nombre || "";
        document.getElementById("cdactivo").value = rol?.estado ? "1" : "0";
        document.getElementById("mensajeError").classList.add("d-none");

        const modal = new bootstrap.Modal(document.getElementById("FormModal1"));
        modal.show();
    }

    function Guardar() {
        const id = parseInt(document.getElementById("txtid").value);
        const nombre = document.getElementById("txtNombre").value.trim();
        const estado = document.getElementById("cdactivo").value === "1";

        const data = {
            id_rol: id,
            nombre: nombre,
            estado: estado
        };

        fetch('@Url.Action("GuardarRol", "Administracion")', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ objeto: data })
        })
        .then(res => res.json())
        .then(res => {
            if (res.resultado === 0 || res.resultado === false) {
                mostrarError(res.mensaje || "No se pudo guardar");
            } else {
                bootstrap.Modal.getInstance(document.getElementById("FormModal1")).hide();
                cargarRoles();
            }
        })
        .catch(err => {
            mostrarError("Error inesperado");
            console.error(err);
        });
    }

    function inactivarRol(id) {
        if (!confirm("¿Está seguro de inactivar este rol?")) return;

        fetch('@Url.Action("EliminarRol", "Administracion")', {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: id })
        })
        .then(res => res.json())
        .then(res => {
            if (res.resultado) {
                cargarRoles();
            } else {
                alert(res.mensaje || "No se pudo inactivar el rol");
            }
        })
        .catch(err => {
            console.error("Error al inactivar el rol:", err);
            alert("Error inesperado al inactivar el rol.");
        });
    }

    function mostrarError(msg) {
        const mensaje = document.getElementById("mensajeError");
        mensaje.textContent = msg;
        mensaje.classList.remove("d-none");
    }
    </script>
}
